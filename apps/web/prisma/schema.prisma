// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  CLIENT
  TEAM_MEMBER
  TEAM_OWNER
  ADMIN
}

enum SubscriptionPlan {
  STARTER
  PRO
  BUSINESS
}

enum SubscriptionStatus {
  INACTIVE
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
}

enum ProspectStage {
  new
  contacted
  meeting
  negotiation
  won
  lost
}

enum ProspectSource {
  csv_import
  url_scraping
  manual
  api
  integration
}

enum MessageStatus {
  draft
  scheduled
  sent
  delivered
  opened
  clicked
  replied
  bounced
  failed
}

enum MessageChannel {
  email
  linkedin
  sms
  whatsapp
}

enum CampaignStatus {
  draft
  active
  paused
  completed
  archived
}

enum Language {
  en
  fr
}

enum DataRegion {
  US
  EU
  CA
}

// User model
model User {
  id                String            @id @default(uuid())
  email             String            @unique
  firstName         String
  lastName          String
  hashedPassword    String
  role              UserRole          @default(CLIENT)
  plan              SubscriptionPlan  @default(STARTER)
  companyName       String?
  language          Language          @default(en)
  dataRegion        DataRegion        @default(EU)
  timezone          String            @default("UTC")
  isEmailVerified   Boolean           @default(false)
  lastLoginAt       DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  // Relations
  icps              ICP[]
  prospects         Prospect[]
  emailSequences    EmailSequence[]
  emailTemplates    EmailTemplate[]
  campaigns         Campaign[]
  activities        Activity[]
  insights          AIInsight[]
  sessions          Session[]
  subscription      Subscription?
  auditLogs         AuditLog[]
}

// Session model for auth
model Session {
  id            String   @id @default(uuid())
  userId        String
  token         String   @unique
  refreshToken  String   @unique
  expiresAt     DateTime
  ipAddress     String?
  userAgent     String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
}

// Audit Log model for compliance and security
model AuditLog {
  id            String    @id @default(uuid())
  userId        String
  action        String
  resource      String
  resourceId    String?
  ipAddress     String?
  userAgent     String?   @db.Text
  metadata      Json?
  createdAt     DateTime  @default(now())
  
  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, action, createdAt])
  @@index([resource, resourceId])
}

// Subscription model - UPDATED
model Subscription {
  id                   String             @id @default(uuid())
  userId               String             @unique
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?            // Added for webhook
  plan                 SubscriptionPlan   @default(STARTER)
  status               SubscriptionStatus @default(INACTIVE)
  trialEndsAt          DateTime?          // Added for trial support
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?          // Added for cancellation tracking
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  
  // Relations
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  usage                SubscriptionUsage?
  payments             Payment[]
}

// NEW: Subscription Usage model
model SubscriptionUsage {
  id                String    @id @default(uuid())
  subscriptionId    String    @unique
  prospectsUsed     Int       @default(0)
  prospectsLimit    Int       @default(200)
  icpsUsed          Int       @default(0)
  icpsLimit         Int       @default(1)
  sequencesUsed     Int       @default(0)
  sequencesLimit    Int       @default(1)
  messagesUsed      Int       @default(0)
  messagesLimit     Int       @default(1000)
  periodStart       DateTime
  periodEnd         DateTime
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  subscription      Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
}

// NEW: Payment model
model Payment {
  id                   String    @id @default(uuid())
  subscriptionId       String
  stripePaymentId      String    @unique
  stripeInvoiceId      String?   @unique
  amount               Int       // in cents
  currency             String    @default("USD")
  status               String    // SUCCEEDED, FAILED, PENDING
  failureReason        String?
  billingPeriodStart   DateTime?
  billingPeriodEnd     DateTime?
  paidAt               DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  
  // Relations
  subscription         Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  @@index([subscriptionId, status])
}

// ICP (Ideal Customer Profile)
model ICP {
  id            String    @id @default(uuid())
  userId        String
  name          String
  description   String?
  criteria      Json
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  prospects     Prospect[]
  sequences     EmailSequence[]
}

// Prospect model
model Prospect {
  id              String         @id @default(uuid())
  userId          String
  icpId           String
  email           String
  firstName       String?
  lastName        String?
  jobTitle        String?
  company         Json
  linkedinUrl     String?
  websiteUrl      String?
  phone           String?
  notes           String?
  score           Int            @default(0)
  scoreExplanation Json?
  stage           ProspectStage  @default(new)
  source          ProspectSource @default(manual)
  lastContactedAt DateTime?
  nextFollowUpAt  DateTime?
  isOptedOut      Boolean        @default(false)
  customFields    Json?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Relations
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  icp             ICP            @relation(fields: [icpId], references: [id], onDelete: Cascade)
  messages        Message[]
  activities      Activity[]
  
  @@index([userId, email])
}

// Email Template model
model EmailTemplate {
  id            String    @id @default(uuid())
  userId        String
  name          String
  subject       String
  content       String    @db.Text
  type          String    @default("CUSTOM") // CUSTOM, INTRO, FOLLOW_UP, etc.
  language      Language  @default(en)
  isActive      Boolean   @default(true)
  usageCount    Int       @default(0)
  metadata      Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, type])
}

// Email Sequence
model EmailSequence {
  id            String    @id @default(uuid())
  userId        String
  icpId         String
  name          String
  description   String?
  isActive      Boolean   @default(true)
  stats         Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  icp           ICP       @relation(fields: [icpId], references: [id], onDelete: Cascade)
  steps         EmailSequenceStep[]
  campaigns     Campaign[]
}

// Email Sequence Step
model EmailSequenceStep {
  id            String    @id @default(uuid())
  sequenceId    String
  stepNumber    Int
  subject       String
  content       String    @db.Text
  delayDays     Int       @default(0)
  conditions    Json?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  sequence      EmailSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  messages      Message[]
}

// Campaign
model Campaign {
  id            String         @id @default(uuid())
  userId        String
  name          String
  description   String?
  sequenceId    String
  status        CampaignStatus @default(draft)
  startedAt     DateTime?
  completedAt   DateTime?
  stats         Json?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  sequence      EmailSequence  @relation(fields: [sequenceId], references: [id])
  messages      Message[]
}

// Message
model Message {
  id              String         @id @default(uuid())
  prospectId      String
  campaignId      String?
  sequenceStepId  String?
  type            String         @default("manual")
  channel         MessageChannel @default(email)
  subject         String?
  content         String         @db.Text
  status          MessageStatus  @default(draft)
  sentAt          DateTime?
  deliveredAt     DateTime?
  openedAt        DateTime?
  clickedAt       DateTime?
  repliedAt       DateTime?
  metadata        Json?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Relations
  prospect        Prospect       @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  campaign        Campaign?      @relation(fields: [campaignId], references: [id])
  sequenceStep    EmailSequenceStep? @relation(fields: [sequenceStepId], references: [id])
  
  @@index([prospectId, status])
}

// Activity
model Activity {
  id            String    @id @default(uuid())
  userId        String
  prospectId    String
  type          String
  title         String
  description   String?
  scheduledAt   DateTime?
  completedAt   DateTime?
  reminder      Json?
  metadata      Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  prospect      Prospect  @relation(fields: [prospectId], references: [id], onDelete: Cascade)
}

// AI Insight
model AIInsight {
  id            String    @id @default(uuid())
  userId        String
  type          String
  title         String
  description   String    @db.Text
  priority      String    @default("medium")
  actionable    Boolean   @default(false)
  metadata      Json?
  isRead        Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}
